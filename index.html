<!DOCTYPE html>
<html lang="en">
<head>
     <meta charset="UTF-8">
     <meta name="viewport" content="width=device-width, initial-scale=1.0">
     <title>True Video FPS Detector</title>
     <style>
         * {
             box-sizing: border-box;
             margin: 0;
             padding: 0;
         }
         
         body {
             font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
             line-height: 1.6;
             color: #333;
             background-color: #f7f9fc;
             padding: 20px;
         }
         
         .container {
             max-width: 800px;
             margin: 0 auto;
             background: white;
             padding: 30px;
             border-radius: 8px;
             box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
         }
         
         h1 {
             color: #2c3e50;
             margin-bottom: 20px;
             text-align: center;
             font-weight: 600;
         }
         
         .instructions {
             margin-bottom: 25px;
             text-align: center;
         }
         
         .instructions p {
             margin-bottom: 10px;
             font-size: 16px;
         }
         
         .file-drop {
             border: 2px dashed #ccc;
             border-radius: 8px;
             padding: 40px 20px;
             text-align: center;
             cursor: pointer;
             transition: border-color 0.3s, background-color 0.3s;
             margin-bottom: 25px;
         }
         
         .file-drop:hover, .file-drop.highlight {
             border-color: #4a90e2;
             background-color: #f0f7ff;
         }
         
         .file-drop p {
             margin-bottom: 15px;
             font-size: 18px;
             color: #555;
         }
         
         .file-input {
             display: inline-block;
             padding: 12px 24px;
             background-color: #4a90e2;
             color: white;
             border-radius: 4px;
             font-weight: 500;
             cursor: pointer;
             transition: background-color 0.3s;
         }
         
         .file-input:hover {
             background-color: #3a7bc8;
         }
         
         #fileSelector {
             display: none;
         }
         
         .progress {
             height: 6px;
             background-color: #eee;
             border-radius: 3px;
             margin-bottom: 25px;
             overflow: hidden;
         }
         
         .progress-fill {
             height: 100%;
             background-color: #4caf50;
             width: 0%;
             transition: width 0.3s ease;
         }
         
         .progress-label {
             text-align: center;
             margin-bottom: 10px;
             font-size: 14px;
             color: #666;
         }
         
         .results {
             padding: 20px;
             border: 1px solid #eee;
             border-radius: 6px;
             margin-top: 20px;
             display: none;
         }
         
         .results h2 {
             margin-bottom: 15px;
             color: #2c3e50;
             font-weight: 600;
         }
         
         .fps-value {
             font-size: 40px;
             font-weight: 700;
             color: #4a90e2;
             margin: 10px 0;
             text-align: center;
         }
         
         .fps-subtitle {
             font-size: 14px;
             color: #666;
             text-align: center;
             margin-bottom: 20px;
         }
         
         .analysis-details {
             margin-top: 20px;
             font-size: 14px;
             color: #666;
             line-height: 1.5;
         }
         
         .error {
             color: #e74c3c;
             text-align: center;
             margin-bottom: 15px;
             font-weight: 500;
             display: none;
         }
         
         .note {
             font-style: italic;
             color: #777;
             font-size: 13px;
             margin-top: 10px;
         }
         
         .hidden {
             display: none;
         }
     </style>
</head>
<body>
    <div class="container">
        <h1>Video Frame Rate Detector</h1>
        <div class="instructions">
            <p>Drag and drop a video file below to detect its true frame rate (FPS).</p>
            <p>Analysis is performed entirely in your browser - no data is uploaded.</p>
        </div>
        
        <div class="error" id="errorMessage"></div>
        
        <div class="file-drop" id="dropZone">
            <p>Drop video file here</p>
            <div class="file-input">Select video file</div>
            <input type="file" id="fileSelector" accept="video/*">
        </div>
        
        <div class="progress-container hidden" id="progressContainer">
            <div class="progress-label">Analyzing: <span id="progressPercent">0</span>%</div>
            <div class="progress">
                <div class="progress-fill" id="progressFill"></div>
            </div>
        </div>
        
        <div class="results" id="resultsContainer">
            <h2>Results:</h2>
            <div class="fps-value" id="fpsValue">--</div>
            <div class="fps-subtitle" id="fpsSubtitle"></div>
            <div class="analysis-details" id="analysisDetails"></div>
        </div>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // DOM elements
            const dropZone = document.getElementById('dropZone');
            const fileSelector = document.getElementById('fileSelector');
            const progressContainer = document.getElementById('progressContainer');
            const progressPercent = document.getElementById('progressPercent');
            const progressFill = document.getElementById('progressFill');
            const resultsContainer = document.getElementById('resultsContainer');
            const fpsValue = document.getElementById('fpsValue');
            const fpsSubtitle = document.getElementById('fpsSubtitle');
            const analysisDetails = document.getElementById('analysisDetails');
            const errorMessage = document.getElementById('errorMessage');
            
            // Event listeners for drag and drop
            dropZone.addEventListener('dragover', function(e) {
                e.preventDefault();
                dropZone.classList.add('highlight');
            });
            
            dropZone.addEventListener('dragleave', function() {
                dropZone.classList.remove('highlight');
            });
            
            dropZone.addEventListener('drop', function(e) {
                e.preventDefault();
                dropZone.classList.remove('highlight');
                
                if (e.dataTransfer.files.length > 0) {
                    processFile(e.dataTransfer.files[0]);
                }
            });
            
            // Click to select file
            dropZone.addEventListener('click', function() {
                fileSelector.click();
            });
            
            fileSelector.addEventListener('change', function() {
                if (fileSelector.files.length > 0) {
                    processFile(fileSelector.files[0]);
                }
            });
            
            // Process the selected video file
            function processFile(file) {
                // Reset UI
                errorMessage.style.display = 'none';
                resultsContainer.style.display = 'none';
                fpsSubtitle.textContent = '';
                
                // Validate file type
                if (!file.type.includes('video/')) {
                    showError('Please select a valid video file.');
                    return;
                }
                
                // Show progress indicator
                progressContainer.classList.remove('hidden');
                progressPercent.textContent = '0';
                progressFill.style.width = '0%';
                
                // Create a URL for the video file
                const videoUrl = URL.createObjectURL(file);
                
                // Detect the frame rate
                detectTrueFPS(videoUrl, file.name);
            }
            
            function detectTrueFPS(videoUrl, fileName) {
                const video = document.createElement('video');
                video.preload = 'auto';
                video.muted = true;
                video.src = videoUrl;
                
                // Create canvas for frame analysis
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d', { willReadFrequently: true });
                canvas.width = 160;  // Small size for performance
                canvas.height = 90;
                
                // Error handling
                video.onerror = function() {
                    URL.revokeObjectURL(videoUrl);
                    showError('Error loading video. The format may not be supported by your browser.');
                };
                
                // Start analysis once metadata is loaded
                video.onloadedmetadata = function() {
                    const duration = video.duration;
                    
                    if (duration < 1) {
                        showError('Video is too short to analyze. Please use a video that is at least 1 second long.');
                        URL.revokeObjectURL(videoUrl);
                        return;
                    }
                    
                    // Perform fixed-interval analysis
                    analyzeWithFixedIntervals(duration)
                        .then(result => {
                            // Display results
                            displayResults({
                                fps: result.uniqueFrames,
                                isVariable: false,
                                confidence: 100,
                                details: `Analyzed using high-precision frame detection at 5ms intervals.<br>
                                        Detected ${result.uniqueFrames} unique frames over ${result.actualDuration.toFixed(3)} seconds.`
                            }, fileName);
                            URL.revokeObjectURL(videoUrl);
                        })
                        .catch(error => {
                            showError('Analysis error: ' + error.message);
                            URL.revokeObjectURL(videoUrl);
                        });
                };
                
                // Analyze video with fixed 5ms intervals
                async function analyzeWithFixedIntervals(duration) {
                    return new Promise((resolve, reject) => {
                        // Set starting point (skip potential blank frames at beginning)
                        const startTime = Math.min(0.5, duration * 0.1);
                        let currentTime = startTime;
                        
                        const samplingInterval = 0.005; // 5ms sampling (200Hz)
                        const maxSamples = 200; // Total 1 second of samples
                        let sampleCount = 0;
                        let lastFrameSignature = null;
                        let firstSampleTime = null;
                        let lastSampleTime = null;
                        
                        // Track unique frames
                        let uniqueFrames = 0;
                        
                        // Position video at start
                        video.currentTime = startTime;
                        
                        video.onseeked = function initialSeek() {
                            // Capture first frame
                            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                            lastFrameSignature = computeFrameSignature(ctx);
                            firstSampleTime = currentTime;
                            uniqueFrames = 1; // Count first frame
                            
                            // Start sampling
                            currentTime += samplingInterval;
                            sampleCount = 1;
                            updateProgress(5); // Start progress at 5%
                            
                            // Change function to handle subsequent seeks
                            video.onseeked = checkForFrameChange;
                            
                            // Seek to next position
                            video.currentTime = currentTime;
                        };
                        
                        function checkForFrameChange() {
                            // Update progress
                            const progressPercent = 5 + (sampleCount / maxSamples) * 90;
                            updateProgress(progressPercent);
                            
                            // Remember this sample time
                            lastSampleTime = currentTime;
                            
                            // Draw current frame to canvas
                            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                            const currentSignature = computeFrameSignature(ctx);
                            
                            // Check if this is a new frame
                            if (!isSameFrame(currentSignature, lastFrameSignature)) {
                                uniqueFrames++;
                                lastFrameSignature = currentSignature;
                            }
                            
                            // Move to next sample point
                            currentTime += samplingInterval;
                            sampleCount++;
                            
                            // Stop after max samples or end of video
                            if (sampleCount >= maxSamples || currentTime >= duration) {
                                // Calculate actual duration sampled
                                const actualDuration = lastSampleTime - firstSampleTime + samplingInterval;
                                
                                resolve({
                                    uniqueFrames: uniqueFrames,
                                    actualDuration: actualDuration,
                                    samples: sampleCount
                                });
                                return;
                            }
                            
                            // Continue to next sample
                            video.currentTime = currentTime;
                        }
                        
                        // Compute optimized frame signature
                        function computeFrameSignature(ctx) {
                            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height).data;
                            
                            // Use a 16x9 grid for signature (matches 16:9 aspect ratio)
                            const signature = new Uint8Array(144); // 16x9 grid
                            const blockWidth = Math.floor(canvas.width / 16);
                            const blockHeight = Math.floor(canvas.height / 9);
                            
                            let index = 0;
                            for (let y = 0; y < 9; y++) {
                                for (let x = 0; x < 16; x++) {
                                    // Sample center of each block
                                    const pixelX = x * blockWidth + Math.floor(blockWidth / 2);
                                    const pixelY = y * blockHeight + Math.floor(blockHeight / 2);
                                    
                                    const idx = (pixelY * canvas.width + pixelX) * 4;
                                    
                                    // Use luminance for change detection
                                    const luma = Math.round(
                                        0.299 * imageData[idx] + 
                                        0.587 * imageData[idx + 1] + 
                                        0.114 * imageData[idx + 2]
                                    );
                                    
                                    signature[index++] = luma;
                                }
                            }
                            
                            return signature;
                        }
                        
                        // Check if two frames are the same
                        function isSameFrame(sig1, sig2) {
                            if (!sig1 || !sig2) return false;
                            
                            // Threshold for pixel difference to be considered changed
                            const pixelThreshold = 5;
                            
                            // How many changed pixels needed to consider a new frame
                            const changedBlockThreshold = 8;
                            
                            let changedBlocks = 0;
                            
                            for (let i = 0; i < sig1.length; i++) {
                                if (Math.abs(sig1[i] - sig2[i]) > pixelThreshold) {
                                    changedBlocks++;
                                    
                                    // Early exit for efficiency
                                    if (changedBlocks > changedBlockThreshold) {
                                        return false; // Different frame
                                    }
                                }
                            }
                            
                            return true; // Same frame
                        }
                    });
                }
            }
            
            // Display the results
            function displayResults(result, fileName) {
                // Hide progress, show results
                progressContainer.classList.add('hidden');
                resultsContainer.style.display = 'block';
                
                // Update results
                fpsValue.textContent = result.fps;
                
                // Add subtitle
                if (result.isVariable) {
                    fpsSubtitle.textContent = `Variable frame rate detected`;
                } else {
                    fpsSubtitle.textContent = `Constant frame rate (${result.confidence}% confidence)`;
                }
                
                analysisDetails.innerHTML = `
                    <p>File analyzed: ${fileName}</p>
                    <p>${result.details}</p>
                    <p class="note">Note: Results based on high-precision 5ms interval sampling over one second period.</p>
                `;
            }
            
            // Show error message
            function showError(message) {
                errorMessage.textContent = message;
                errorMessage.style.display = 'block';
                progressContainer.classList.add('hidden');
            }
        });
    </script>
</body>
</html>
